<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babulab</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #5fbce5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0;
            padding: 20px;
        }

        /* Logo Babulab */
        #logo {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        #logo img {
            width: 300px;
        }

        /* Container for file upload */
        #file-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #upload-btn-wrapper {
            position: relative;
            display: inline-block;
        }

        #imageUpload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        #upload-btn-wrapper img {
            width: 70%;
            cursor: pointer;
        }

        /* Thumbnail container for funtraits */
        #thumbnail-container {
            margin-top: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        #thumbnail-container img {
            cursor: pointer;
            width: 80px;
            height: 80px;
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #thumbnail-container img.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Canvas container */
        #canvas-container {
            position: relative;
            width: 100%;
            max-width: 620px;
            height: auto;
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 20px;
        }

        #output-canvas {
            width: 100%;
            height: auto;
            z-index: 1;
        }

        #canvas-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('images/canvas-border.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            pointer-events: none;
            opacity: 0.5; /* Initial opacity */
        }

        #buttons-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        #download-btn-wrapper img,
        #copy-btn-wrapper img {
            width: 50%;
            cursor: pointer;
        }

        #buttons-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

#input-id-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
    text-align: center;
}

#imageIdInput {
    width: 100px;
    padding: 8px;
    font-size: 16px;
    margin-top: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    text-align: center;
}


    </style>
</head>
<body>

    <div id="logo">
        <img src="images/babulab-logo.png" alt="Babulab Logo">
    </div>

    <div id="file-upload-container">
        <div id="upload-btn-wrapper">
            <img src="images/upload-btn.png" alt="Upload Button">
            <input type="file" id="imageUpload" accept="image/*">
        </div>
    </div>

<div id="input-id-wrapper">
    <img id="title-image" src="images/id-title.png" alt="ID Title" style="width: 50%; margin-bottom: 5px;">
    <input type="number" id="imageIdInput" min="1" max="690" placeholder="1-690">
</div>




    <div id="thumbnail-container">
        <!-- The thumbnails will be dynamically created via JS -->
    </div>

    <div id="canvas-container">
        <canvas id="output-canvas" width="600" height="600"></canvas>
        <div id="canvas-frame"></div>
    </div>

    <div id="buttons-container">
        <div id="download-btn-wrapper">
            <img id="download-btn" src="images/download-btn.png" alt="Download Button" onclick="downloadImage()">
        </div>
        <div id="copy-btn-wrapper">
            <img id="copy-btn" src="images/copy-btn.png" alt="Copy Button" onclick="copyImage()">
        </div>
    </div>

<script>
    const imageUpload = document.getElementById('imageUpload');
    const canvas = document.getElementById('output-canvas');
    const ctx = canvas.getContext('2d');
    const downloadBtnWrapper = document.getElementById('download-btn-wrapper');
    const copyBtnWrapper = document.getElementById('copy-btn-wrapper');
    const buttonsContainer = document.getElementById('buttons-container');
    const thumbnailContainer = document.getElementById('thumbnail-container');
    const canvasFrame = document.getElementById('canvas-frame');
    let uploadedImage = null;
    let activeFuntraits = [];


const imageIdInput = document.getElementById('imageIdInput');

imageIdInput.addEventListener('change', function() {
    const imageId = parseInt(imageIdInput.value);
    if (imageId >= 1 && imageId <= 690) {
        const imageUrl = `https://ipfs-gw.stargaze-apis.com/ipfs/bafybeictugfluo7kqbelwuuvlrzofgshgxuhznvjqyxgni6j3jeqzua6oa/${imageId}.png`;

        console.log("Generated URL:", imageUrl);
    } else {
        alert("Please enter a valid ID between 1 and 690.");
    }
});

function loadImageToCanvas(url) {
    const titleImage = document.getElementById('title-image');
    
    // Affiche l'image de chargement
    titleImage.src = 'images/loading.gif';

    const img = new Image();
    img.crossOrigin = "anonymous"; // Pour éviter les problèmes de CORS
    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Efface le canvas
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // Dessine l'image dans le canvas
        uploadedImage = img; // Stocke l'image dans uploadedImage
        buttonsContainer.style.display = 'flex'; // Affiche les boutons "Download" et "Copy"
        canvasFrame.style.opacity = 1; // Montre le cadre du canvas
        
        activeFuntraits = []; // Réinitialise les funtraits actifs
        activateThumbnails(); // Active les thumbnails

        // Remet l'image de titre une fois le chargement terminé
        titleImage.src = 'images/id-title.png';
    };
    
    img.src = url;
}

// Réinitialise les funtraits actifs également après un upload d'image
imageUpload.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
            uploadedImage = img;
            drawCanvas();
            buttonsContainer.style.display = 'flex';
            canvasFrame.style.opacity = 1;
            activeFuntraits = []; // Réinitialise les funtraits actifs
            activateThumbnails();
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
});


// Utilise loadImageToCanvas avec l'URL générée
imageIdInput.addEventListener('change', function() {
    const imageId = parseInt(imageIdInput.value);
    if (imageId >= 1 && imageId <= 690) {
        const imageUrl = `https://ipfs-gw.stargaze-apis.com/ipfs/bafybeictugfluo7kqbelwuuvlrzofgshgxuhznvjqyxgni6j3jeqzua6oa/${imageId}.png`;
        loadImageToCanvas(imageUrl);
    } else {
        alert("Please enter a valid ID between 1 and 690.");
    }
});

function activateThumbnails() {
    document.querySelectorAll('#thumbnail-container img').forEach(thumb => thumb.classList.add('active'));
}


   const funtraits = [
    { name: 'stars', src: 'funtraits/stars.png', z: -1, thumb: 'thumbnails/stars-thumbnail.png' },	
    { name: 'babultra', src: 'funtraits/babultra.png', z: 8, thumb: 'thumbnails/babultra-thumbnail.png' },
    { name: 'onfire', src: 'funtraits/onfire.png', z: 8, thumb: 'thumbnails/onfire-thumbnail.png' },
    { name: 'madbabu', src: 'funtraits/madbabu.png', z: 0, thumb: 'thumbnails/madbabu-thumbnail.png' },
    { name: 'poopchest', src: 'funtraits/poopchest.png', z: -2, thumb: 'thumbnails/poopchest-thumbnail.png' },
    { name: 'clown', src: 'funtraits/clown.png', z: 3, thumb: 'thumbnails/clown-thumbnail.png' },
    { name: '687', src: 'funtraits/687.png', z: -1, thumb: 'thumbnails/687-thumbnail.png' },
    { name: 'kult', src: 'funtraits/kult.png', z: -1, thumb: 'thumbnails/kult-thumbnail.png' },
    { name: 'miami', src: 'funtraits/miami.png', z: 4, thumb: 'thumbnails/miami-thumbnail.png' },
    { name: 'brekkingneus', src: 'funtraits/brekkingneus.png', z: 8, thumb: 'thumbnails/brekkingneus-thumbnail.png' },
    { name: 'babulieve', src: 'funtraits/babulieve.png', z: 5, thumb: 'thumbnails/babulieve-thumbnail.png' },
    { name: 'whypamp', src: 'funtraits/whypamp.png', z: 5, thumb: 'thumbnails/whypamp-thumbnail.png' },
    { name: '1000x', src: 'funtraits/1000x.png', z: 5, thumb: 'thumbnails/1000x-thumbnail.png' },
    { name: 'babuvil', src: 'funtraits/babuvil.png', z: -2, thumb: 'thumbnails/babuvil-thumbnail.png' },
    { name: 'babangel', src: 'funtraits/babangel.png', z: -2, thumb: 'thumbnails/babangel-thumbnail.png' },
    { name: 'neuspeppa', src: 'funtraits/neuspeppa.png', z: 10, thumb: 'thumbnails/neuspeppa-thumbnail.png' },
    { name: 'plantinghamsters', src: 'funtraits/plantinghamsters.png', z: 6, thumb: 'thumbnails/plantinghamsters-thumbnail.png' },
    { name: 'baguette', src: 'funtraits/baguette.png', z: 9, thumb: 'thumbnails/baguette-thumbnail.png' }
];

const incompatibilities = {
    'babultra': ['babuvil', 'babangel', 'madbabu', 'onfire'],
    'onfire': ['babuvil', 'babangel', 'madbabu', 'babultra'],
    'madbabu': ['miami', 'babuvil', 'babangel', 'onfire', 'babultra'],
    'babuvil': ['plantinghamsters', 'madbabu', 'onfire', 'babultra'],
    'plantinghamsters': ['babuvil'],
    'baguette': ['babangel'],
    'babangel': ['baguette', 'madbabu', 'onfire', 'babultra'],
    '687': ['kult', 'babulieve', 'whypamp', '1000x', 'stars'],
    'kult': ['687', 'babulieve', 'whypamp', '1000x', 'stars'],
    'babulieve': ['687', 'kult', 'whypamp', '1000x', 'stars'],
    'whypamp': ['687', 'kult', 'babulieve', '1000x', 'stars'],
    '1000x': ['687', 'kult', 'babulieve', 'whypamp', 'stars'],
    'stars': ['687', 'babulieve', 'whypamp', '1000x', 'kult'],
    'miami': ['madbabu']
};


    // Affichage des thumbnails dans l'ordre du tableau
    funtraits.forEach(funtrait => {
        const img = document.createElement('img');
        img.src = funtrait.thumb;
        img.alt = funtrait.name + ' Thumbnail';
        img.onclick = () => toggleFuntrait(funtrait.name);
        thumbnailContainer.appendChild(img);
    });

    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                uploadedImage = img;
                drawCanvas();
                buttonsContainer.style.display = 'flex';
                canvasFrame.style.opacity = 1;
                document.querySelectorAll('#thumbnail-container img').forEach(thumb => thumb.classList.add('active'));
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    function preloadImage(src, callback) {
        const img = new Image();
        img.onload = function() {
            callback(img);
        };
        img.src = src;
    }

    
function toggleFuntrait(name) {
    const index = activeFuntraits.findIndex(f => f.name === name);
    if (index > -1) {
        activeFuntraits.splice(index, 1);
    } else {
        // Retirer les funtraits incompatibles
        if (incompatibilities[name]) {
            incompatibilities[name].forEach(incompatibleName => {
                const incompatibleIndex = activeFuntraits.findIndex(f => f.name === incompatibleName);
                if (incompatibleIndex > -1) {
                    activeFuntraits.splice(incompatibleIndex, 1);
                }
            });
        }
        const funtrait = funtraits.find(f => f.name === name);
        activeFuntraits.push({ name: name, ...funtrait });
    }
    preloadAllFuntraitsAndDraw();
}

function preloadAllFuntraitsAndDraw() {
    const imagesToDraw = [];
    let loadedCount = 0;

    // Tri des funtraits actifs par z-index avant le rendu
    activeFuntraits.sort((a, b) => a.z - b.z);

    activeFuntraits.forEach((funtrait, index) => {
        preloadImage(funtrait.src, function(img) {
            imagesToDraw[index] = img;
            loadedCount++;
            if (loadedCount === activeFuntraits.length) {
                drawCanvas(imagesToDraw);
            }
        });
    });
}



    function drawCanvas(preloadedImages = []) {
        if (!uploadedImage) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);
        preloadedImages.forEach(img => {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        });
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.setAttribute('href', canvas.toDataURL('image/jpeg'));
        link.setAttribute('download', 'image-with-layer.jpg');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function copyImage() {
        canvas.toBlob(blob => {
            const item = new ClipboardItem({ "image/png": blob });
            navigator.clipboard.write([item]).then(() => {
                alert("Image copied to clipboard!");
            }).catch(err => {
                console.error("Failed to copy image:", err);
            });
        });
    }
</script>

   
</body>
</html>